unit uMain;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.ComCtrls, Vcl.OleCtrls, SHDocVw,urlmon,strutils,
  Vcl.ExtCtrls, Vcl.StdCtrls,uhookweb,activex,mshtml,uDown,uConfig, Vcl.Menus,shellapi,uData,
  Vcl.Buttons,uFuncs;

type
  TfMain = class(TForm)
    Panel1: TPanel;
    edturl: TEdit;
    Bar1: TStatusBar;
    Page1: TPageControl;
    tsData: TTabSheet;
    tsInfo: TTabSheet;
    memData: TMemo;
    MemoInfo: TMemo;
    Panel2: TPanel;
    Splitter1: TSplitter;
    listData: TListView;
    Splitter2: TSplitter;
    Page2: TPageControl;
    tsweb: TTabSheet;
    tscode: TTabSheet;
    Web1: TWebBrowser;
    memCode: TMemo;
    Web2: TWebBrowser;
    btnClear: TButton;
    chkDownAll: TCheckBox;
    PopSelData: TPopupMenu;
    nOpenDir: TMenuItem;
    btnBack: TBitBtn;
    btnForward: TBitBtn;
    btnBrush: TBitBtn;
    nOpenRequestData: TMenuItem;
    n1: TMenuItem;
    nOpenResponseData: TMenuItem;
    procedure FormShow(Sender: TObject);
    procedure Web1DocumentComplete(ASender: TObject; const pDisp: IDispatch;
      const URL: OleVariant);
    procedure Web1NavigateComplete2(ASender: TObject; const pDisp: IDispatch;
      const URL: OleVariant);
    procedure listDataSelectItem(Sender: TObject; Item: TListItem;
      Selected: Boolean);
    procedure Web2BeforeNavigate2(ASender: TObject; const pDisp: IDispatch;
      const URL, Flags, TargetFrameName, PostData, Headers: OleVariant;
      var Cancel: WordBool);
    procedure Web1NewWindow2(ASender: TObject; var ppDisp: IDispatch;
      var Cancel: WordBool);
    procedure Web1BeforeNavigate2(ASender: TObject; const pDisp: IDispatch;
      const URL, Flags, TargetFrameName, PostData, Headers: OleVariant;
      var Cancel: WordBool);
    procedure btnClearClick(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure nOpenDirClick(Sender: TObject);
    procedure btnBrushClick(Sender: TObject);
    procedure edturlEnter(Sender: TObject);
    procedure btnBackClick(Sender: TObject);
    procedure btnForwardClick(Sender: TObject);
    procedure nOpenRequestDataClick(Sender: TObject);
    procedure nOpenResponseDataClick(Sender: TObject);
  private
    { Private declarations }

    procedure httpMessage(var MSG:TMessage); message WM_CAP_WORK;
    procedure downMessage(var MSG:TMessage); message WM_DOWN_FILE;
    procedure getResource();
    function findResource(url:string):boolean;
    procedure getDataToShow();
  public
    { Public declarations }
  end;

var
  fMain: TfMain;

implementation

{$R *.dfm}
procedure TfMain.getDataToShow();
var
  data:TListItem;
  i:integer;
begin
  while True do
  begin
  while listData.Items.Count<uData.iData do
  begin
    i:=listData.Items.Count;
    data:=listData.Items.Add;
    data.Caption:=ufuncs.getDataTimeString(uData.datas[i].dt);
    data.SubItems.Add(uData.datas[i].verb);
    data.SubItems.Add(uData.datas[i].url);
    data.SubItems.Add(uData.datas[i].len);
    data.SubItems.Add(uData.datas[i].qHeader);
    data.SubItems.Add(uData.datas[i].rHeader);
    data.SubItems.Add(uData.datas[i].qData);
    data.SubItems.Add(uData.datas[i].rData);
    if(chkDownAll.Checked)then uDown.addUrl(uData.datas[i].url);
    application.ProcessMessages;
  end;
    application.ProcessMessages;
  end;
end;
function TfMain.findResource(url:string):boolean;
const
  mp4='.mp4';
  swf='.swf';
  fla='.fla';
begin
  result:=true;
  if pos(mp4,url)>0 then exit;
  if pos(swf,url)>0 then exit;
  if pos(fla,url)>0 then exit;
  result:=false;
end;
procedure TfMain.getResource();
var
  i:integer;
  url:string;
  ss:tstrings;
begin
  if(listdata.Items.Count=0)then exit;
  ss:=tstringlist.Create;
  for i:=0 to listdata.Items.Count-1 do begin
    url:=listdata.Items.Item[i].SubItems[1];
    if(findResource(url))then ss.Add(url);
  end;
  if(ss.Count>0)then memoinfo.Lines.AddStrings(ss);
  ss.Free;
end;
function getPageCode(doc:IHTMLDocument2;ss:tstrings):tstrings;//返回页面源代码
var
  ms: TMemoryStream;
begin
  if not assigned(ss) then ss:=tstringlist.Create;

  ms := TMemoryStream.Create;
 (doc as IPersistStreamInit).Save(TStreamAdapter.Create(ms), True);
  ms.Position := 0;
  ss.LoadFromStream(ms,TEncoding.UTF8);
  ms.Free;
  result:=ss;
end;

procedure TfMain.downMessage(var msg:TMessage);
var
  i,j:integer;
begin
  i:=msg.LParam;
  j:=msg.WParam;
  if j=1 then
    bar1.Panels[1].Text:='下载完毕！'
  else
    bar1.Panels[1].Text:='已下载：'+inttostr(i)+'['+uDown.mdowns[i]+']';
end;
procedure TfMain.edturlEnter(Sender: TObject);
begin
  btnBrush.click();
end;

procedure TfMain.httpMessage(var msg:TMessage);
var
  len,flag:integer;

begin
  len:=msg.LParam;
  flag:=msg.WParam;
end;
procedure TfMain.listDataSelectItem(Sender: TObject; Item: TListItem;
  Selected: Boolean);
begin
  memData.Clear;
  memData.Lines.Add('-------------request target ---------------');
  memData.Lines.Add(item.SubItems[1]);
  memData.Lines.Add('');
  memData.Lines.Add('');
  memData.Lines.Add('-------------request length---------------');
  memData.Lines.Add(item.SubItems[2]);
  memData.Lines.Add('');
  memData.Lines.Add('');
  memData.Lines.Add('-------------request headers---------------');
  memData.Lines.Add(item.SubItems[3]);
  memData.Lines.Add('------------response headers---------------');
  memData.Lines.Add(item.SubItems[4]);
  memData.Lines.Add('-------------request data------------------');
  memData.Lines.Add(item.SubItems[5]);
  memData.Lines.Add('-------------response data-----------------');
  memData.Lines.Add(item.SubItems[6]);
end;

procedure TfMain.nOpenDirClick(Sender: TObject);
var
  url,localdir:string;
begin
  url:=listdata.Selected.SubItems[1];
  if pos(mSite,url)<=0 then url:=mSite+url;
  localdir:=uDown.url2file(url);
  localdir:=extractfiledir(localdir);
  ShellExecute(Handle,'open','Explorer.exe',pchar(localdir),nil,1);
end;

procedure TfMain.nOpenRequestDataClick(Sender: TObject);
var
  data,localdir:string;
begin
  data:=listdata.Selected.SubItems[5];
  if(data='')then exit;
  ShellExecute(Handle,'open','notepad.exe',pchar(data),nil,1);

end;

procedure TfMain.nOpenResponseDataClick(Sender: TObject);
var
  data,localdir:string;
begin
  data:=listdata.Selected.SubItems[6];
  if(data='')then exit;
  ShellExecute(Handle,'open','notepad.exe',pchar(data),nil,1);

end;

procedure TfMain.btnBackClick(Sender: TObject);
begin
  web1.GoBack;
end;

procedure TfMain.btnBrushClick(Sender: TObject);
begin
  web1.Navigate(trim(edtUrl.Text));
  btnBack.Enabled:=true;
  btnForward.Enabled:=true;
end;

procedure TfMain.btnClearClick(Sender: TObject);
begin
  if MessageBox(0, '即将清空所有数据，请确认!', '警告', MB_OKCANCEL + MB_ICONWARNING) = ID_OK then  begin  //   MB_ICONQUESTION
    listData.Clear;
    memData.Lines.Clear;
    uDown.clear();
    uData.clear;
    bar1.Panels[0].Text:='数据已经清空！';
  end;
end;

procedure TfMain.btnForwardClick(Sender: TObject);
begin
  web1.GoForward;
end;

procedure TfMain.FormClose(Sender: TObject; var Action: TCloseAction);
begin
  uDown.stop;
end;

procedure TfMain.FormShow(Sender: TObject);
begin
  //uhookweb.hForm:=fmain.Handle; //
  getDataToShow();
  uDown.start(uConfig.workdir,fmain.Handle);
  TWinControl(Web2).Visible:=False;
  fmain.Caption:=APP_NAME+'v'+APP_VERSION;
end;

procedure TfMain.Web1BeforeNavigate2(ASender: TObject; const pDisp: IDispatch;
  const URL, Flags, TargetFrameName, PostData, Headers: OleVariant;
  var Cancel: WordBool);
begin
  uDown.pause();
  uHookweb.state:=STAT_BROWSING;
  bar1.Panels[0].Text:='正在加载页面...';
end;

procedure TfMain.Web1DocumentComplete(ASender: TObject; const pDisp: IDispatch;
  const URL: OleVariant);
var
  doc:IHTMLDocument2;
begin
  if not assigned(web1.Document) then exit;
  if(web1.Busy)then exit;

  doc:=web1.Document as IHTMLDocument2;
  getPageCode(doc,memcode.Lines);
  //doc.designMode:='On';
  mPage:=doc.url;
  mPort:=getPort(mPage);
  msite:=doc.domain;
  mProtocol:=doc.protocol;
  if(mProtocol='HyperText Transfer Protocol with Privacy')then mProtocol:='https://' else mProtocol:='http://';

  edturl.Text:=mpage;
  fmain.Caption:=APP_NAME+'v'+APP_VERSION+'('+mpage+')';
  uHookweb.state:=STAT_IDLE;
  bar1.Panels[0].Text:='页面加载完毕！共有：'+inttostr(listdata.Items.Count)+'项！';


  if(chkDownAll.Checked)then begin
    uDown.setHost(mprotocol,msite);
    uDown.addUrl(mPage);
    uDown.start();
  end;
  getResource();

end;

procedure TfMain.Web1NavigateComplete2(ASender: TObject; const pDisp: IDispatch;
  const URL: OleVariant);
begin
  web1.Silent:=true;
end;

procedure TfMain.Web1NewWindow2(ASender: TObject; var ppDisp: IDispatch;
  var Cancel: WordBool);
begin
ppDisp := web2.Application; // 新的窗口先指向WebBrowser2
end;

procedure TfMain.Web2BeforeNavigate2(ASender: TObject; const pDisp: IDispatch;
  const URL, Flags, TargetFrameName, PostData, Headers: OleVariant;
  var Cancel: WordBool);
begin
  web1.Navigate(string(URL)); // 再指回WebBrowser1
  Cancel := True;
end;



//----------------------------------------------函数区---------------------------------------




//-------------------------------------------------------------------------------------------

initialization
  OleInitialize(nil);
finalization
  OleUninitialize;
end.
